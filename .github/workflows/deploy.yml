name: "Sync: Local <-> GitHub <-> Lovable"

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  # 1. Quality Gate (The Guard)
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'src/package-lock.json'
      
      - name: Install Dependencies
        working-directory: ./src
        run: npm ci

      - name: Lint
        working-directory: ./src
        run: npm run lint

      # Placeholder for Tests (Phase 8)
      # - name: Test
      #   run: npm run test

      # Placeholder for Compliance Check (Phase 7)
      # - name: Verify Compliance Matrix
      #   run: ./scripts/verify_compliance.sh

  # 2. Deployment (The Sync)
  deploy:
    needs: verify
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      PROJECT_ID: "mexrgeafzvcestcccmiy"
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase Project
        run: supabase link --project-ref $PROJECT_ID --password $DB_PASSWORD

      - name: Push Database Schema
        run: supabase db push

      - name: Deploy Edge Functions
        run: supabase functions deploy
        
      # Lovable sync happens automatically via GitHub App integration.
      # When we push to GitHub, Lovable pulls from GitHub.
