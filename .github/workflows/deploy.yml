name: "Sync: Local <-> GitHub <-> Lovable"

# ============================================
# This workflow syncs with Lovable platform.
# 
# TECH STACK: React + Vite (Lovable compatible)
# AUTH: Supabase Auth (Gmail/Magic Link supported)
# 
# NOTE: Supabase deployment is OPTIONAL.
# If DB_PASSWORD secret is not set, Supabase steps are skipped.
# Lovable manages Supabase integration directly.
# ============================================

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  # 1. Quality Gate (The Guard)
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'
      
      - name: Install Dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type Check
        run: npx tsc --noEmit

      - name: Unit Tests
        run: npm run test

      - name: Build Verification
        run: npm run build

  # 2. Deployment (The Sync)
  # NOTE: Supabase steps are now CONDITIONAL.
  # They only run if DB_PASSWORD secret is configured.
  # For Lovable-only mode, these steps are skipped automatically.
  deploy:
    needs: verify
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      PROJECT_ID: "mexrgeafzvcestcccmiy"
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
      
      # Check if Supabase secrets are configured
      - name: Check Supabase Configuration
        id: check_supabase
        run: |
          if [ -n "${{ secrets.DB_PASSWORD }}" ] && [ -n "${{ secrets.SUPABASE_ACCESS_TOKEN }}" ]; then
            echo "supabase_configured=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Supabase secrets are configured"
          else
            echo "supabase_configured=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Supabase secrets not configured - skipping Supabase deployment"
            echo "‚ÑπÔ∏è This is expected for Lovable-only mode"
          fi

      # Supabase CLI Setup (conditional)
      - name: Setup Supabase CLI
        if: steps.check_supabase.outputs.supabase_configured == 'true'
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase Project
        if: steps.check_supabase.outputs.supabase_configured == 'true'
        run: supabase link --project-ref $PROJECT_ID --password $DB_PASSWORD

      - name: Push Database Schema
        if: steps.check_supabase.outputs.supabase_configured == 'true'
        run: supabase db push

      - name: Deploy Edge Functions
        if: steps.check_supabase.outputs.supabase_configured == 'true'
        run: supabase functions deploy
        
      # Success message for Lovable-only mode
      - name: Lovable Sync Complete
        run: |
          echo "‚úÖ Quality gate passed!"
          echo "‚úÖ Build verified!"
          if [ "${{ steps.check_supabase.outputs.supabase_configured }}" == "true" ]; then
            echo "‚úÖ Supabase deployment complete!"
          else
            echo "‚ÑπÔ∏è Lovable-only mode: Supabase sync handled by Lovable"
          fi
          echo "üöÄ Lovable will automatically sync from GitHub"
