name: "Sync: Local <-> GitHub <-> Lovable"

# ============================================
# This workflow syncs with Lovable platform.
# 
# TECH STACK: React + Vite (Lovable compatible)
# AUTH: Supabase Auth (Gmail/Magic Link supported)
# 
# FUTURE MIGRATION: When cloning to Firebase Studios,
# the project can be migrated to Next.js for better
# Firebase integration.
# ============================================

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  # 1. Quality Gate (The Guard)
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          # FIXED: package.json is in root, not src/
          cache-dependency-path: 'package-lock.json'
      
      # FIXED: Run from root directory (where package.json is)
      - name: Install Dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type Check
        run: npx tsc --noEmit

      - name: Unit Tests
        run: npm run test

      - name: Build Verification
        run: npm run build

  # 2. Deployment (The Sync)
  deploy:
    needs: verify
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      PROJECT_ID: "mexrgeafzvcestcccmiy"
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase Project
        run: supabase link --project-ref $PROJECT_ID --password $DB_PASSWORD

      - name: Push Database Schema
        run: supabase db push

      - name: Deploy Edge Functions
        run: supabase functions deploy
        
      # Lovable sync happens automatically via GitHub App integration.
      # When we push to GitHub, Lovable pulls from GitHub.
