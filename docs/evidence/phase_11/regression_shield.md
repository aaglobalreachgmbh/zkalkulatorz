# üõ°Ô∏è Regression Shield Statement (Phase 11.4)

**Status:** ‚úÖ Active
**Date:** 2026-01-19
**Version:** 1.0

---

## Purpose

This document defines which changes **MUST break tests** if attempted without proper review. These are the "guardrails" that protect against regression.

---

## Protected Behaviors

### üî¥ P0: Customer Mode Isolation (No-Leak)

**Test:** `ViewModeGuards.test.tsx`

```
IF viewMode === "customer", THEN DealerOnly returns NULL
NEVER render: ek, cost_price, margin, provision, marge
```

**Breaking Changes:**
- Removing `DealerOnly` guard from dealer content
- Changing `viewMode === "customer"` logic
- Adding dealer content outside guards

---

### üî¥ P0: Admin Route Protection

**Test:** `AdminGuard.test.tsx`

```
IF user is not admin, THEN redirect
IF loading, THEN show spinner (not content)
NEVER render admin content to non-admins
```

**Breaking Changes:**
- Removing `useUserRole` check
- Rendering children before loading completes
- Bypassing redirect logic

---

### üî¥ P0: Input Validation

**Test:** `calculationService.test.ts`

```
IF input invalid (bad UUID, zero volume), THEN reject
NEVER accept malformed calculation input
```

**Breaking Changes:**
- Removing Zod validation
- Accepting invalid productId format
- Accepting zero or negative volume

---

### üü° P1: License State Management

**Test:** `useLicense.test.ts`

```
IF user authenticated, THEN use cloud license
IF user guest, THEN use local license
```

**Breaking Changes:**
- Mixing cloud/local state
- Returning wrong mode indicator

---

### üü° P1: Provision Calculations

**Test:** `provisionLogic.test.ts`

```
IF offer has value, THEN calculate provision correctly
Bonuses and deductions apply after base calculation
```

**Breaking Changes:**
- Changing calculation formulas
- Reordering bonus/deduction application

---

## CI Integration

```bash
# Before any merge to main:
npm run validate

# This runs:
# 1. tsc --noEmit (type check)
# 2. eslint . (lint)
# 3. vitest run (tests)

# If ANY of these fail, the merge is blocked.
```

---

## Flake Status

| Metric | Value |
|--------|-------|
| 3x Consecutive Runs | ‚úÖ PASSED |
| Flaky Tests Detected | 0 |
| Test Duration | ~2s |

---

## Future Additions Required

When adding new critical features, add corresponding tests:

1. **PDF Generation** ‚Üí Verify no secrets in output
2. **CSV Import** ‚Üí Verify validation errors are clear
3. **Offline Mode** ‚Üí Verify data survives reconnect

---

*Generated by Antigravity (Build Sheriff)*
